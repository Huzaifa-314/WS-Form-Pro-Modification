!function(e){"use strict";e.WS_Form.prototype.form_file=function(){var t=this;e('input[type="file"]:not([data-init-file])',this.form_canvas_obj).each(function(){var a=t.get_field(e(this)),i=!1;if("on"===t.get_object_meta_value(a,"file_preview",!1)){var s=t.get_object_meta_value(a,"orientation",!1),r=ws_form_settings.skin_grid_gutter;switch(s){case"grid":var o=t.get_field_value_fallback(a.type,!1,"class_orientation_wrapper",[]),n=t.get_field_value_fallback(a.type,!1,"class_orientation_row",[]);o.push("wsf-file-preview");var l=o.join(" "),d=t.column_class_array(a,"orientation_breakpoint"),p=(d=n.concat(d)).join(" "),_="",c="display: block; height: revert; margin-top: "+r+"px; width: 100%;";break;case"horizontal":l="wsf-file-preview",p="";var f=t.get_object_meta_value(a,"file_preview_width",!1);_="display: inline-block; -webkit-margin-end: "+r+"px; margin-inline-end: "+r+"px; vertical-align: top;"+(!1!==f?" width: "+f+";":""),c="display: block; height: revert; margin-top: "+r+"px; max-width: 100%; width: revert;";break;default:l="wsf-file-preview",p="",_="",c="display: block; height: revert; margin-top: "+r+"px; max-width: 100%; width: 100%;"}i=e("<div"+(""!=l?' class="'+l+'"':"")+"></div>");e(this).closest("[data-type]").append(i)}e(this).on("change",function(){var a=e(this)[0].files;!1!==i&&t.form_file_preview(a,i,p,_,c)}),e(this).attr("data-init-file","")}),"undefined"!=typeof Dropzone&&e('[data-file-type="dropzonejs"]:not([data-init-file])',this.form_canvas_obj).each(function(){var a=t.get_field_id(e(this)),i=t.get_field(e(this));Dropzone.autoDiscover=!1;var s=e(this),r=e(this).attr("id"),o=void 0!==e(this).attr("multiple"),n=e('[data-source="post_progress"]',this.form_canvas_obj),l=t.get_object_meta_value(i,"orientation",!1),d=null,p=null,_=ws_form_settings.skin_grid_gutter;switch(l){case"grid":var c=t.get_field_value_fallback("file",!1,"class_orientation_wrapper",[]);c.push("wsf-dropzonejs-previews");var f=c.join(" "),u=t.get_field_value_fallback("file",!1,"class_orientation_row",[]),m=t.column_class_array(i,"orientation_breakpoint");(m=u.concat(m)).push("wsf-dropzonejs-preview");var v=m.join(" "),h="margin-bottom: "+_+"px;",g="display: block; height: revert; width: 100%;";break;case"horizontal":f="wsf-dropzonejs-previews",v="wsf-dropzonejs-preview";var w=t.get_object_meta_value(i,"file_preview_width",!1),b=(h="display: inline-block; margin-bottom: "+_+"px; -webkit-margin-end: "+_+"px; margin-inline-end: "+_+"px; vertical-align: top;"+(!1!==w?" width: "+w+";":""),g="display: block; width: revert; height: revert; max-width: 100%;",parseInt(t.replace_all(w,"px",""),10));d=b,p=b;break;default:f="wsf-dropzonejs-previews",v="wsf-dropzonejs-preview",h="margin-bottom: "+_+"px;",g="display: block; height: revert; max-width: 100%; width: 100%;"}e("#"+r+"-dropzonejs-previews").attr("class",f);var j=t.get_field_value_fallback("file",!1,"mask_invalid_feedback_dropzonejs",""),z=[];z.invalid_feedback_id="#"+r+"-dropzone-error-message";var y=t.get_field_value_fallback("file",!1,"class_invalid_feedback",[]);z.invalid_feedback_class=y.join(" "),z.invalid_feedback="",z.attributes=" data-dz-errormessage";var k=t.mask_parse(j,z),x=t.get_field_value_fallback("file",!1,"mask_help_dropzonejs",""),O=[];O.help_id="#"+r+"-dropzone-name";var S=t.get_field_value_fallback("file",!1,"class_help",[]);O.help_class=S.join(" "),O.help="",O.help_append="",O.attributes=" data-dz-name";var L=t.mask_parse(x,O);O.attributes=" data-dz-size";var F=t.mask_parse(x,O);O.attributes="",O.help='<a href="#" data-dz-remove>'+t.language("dropzonejs_remove")+"</a>";var I=t.mask_parse(x,O),M='<div class="'+(v?" "+v:"")+(""!=h?'" style="'+h+'"':"")+'">';M+='<img data-dz-thumbnail style="'+(g?" "+g:"")+'" />',M+=k,M+=L,M+=F,M+='<div class="wsf-progress"><div class="wsf-upload" data-dz-uploadprogress></div></div>',M+=I,M+="</div>";var W={url:ws_form_settings.url_ajax+"field/"+a+"/dropzonejs/",paramName:"file",uploadMultiple:o,previewTemplate:M,previewsContainer:"#"+r+"-dropzonejs-previews",thumbnailWidth:d,thumbnailHeight:p,init:function(){this.add_custom_file=function(e,t,a){this.files.push(e),this.emit("addedfile",e),this.emit("thumbnail",e,t),this.emit("processing",e),this.emit("success",e,a,!1),this.emit("complete",e),this.element.classList.add("dz-started")},this.ajax_complete=function(){t.dropzonejs_processes>0&&t.dropzonejs_processes--,0===t.dropzonejs_processes&&(t.form_post_unlock("progress",!1,!0),n.each(function(){t.form_progress_set_value(e(this),0)}))},this.input_update=function(){var e={};for(var t in Q.files)if(Q.files.hasOwnProperty(t)){var a=Q.files[t];"success"===a.status&&void 0!==a.upload.uuid&&void 0!==a.upload.attachment_id&&(e[a.upload.uuid]=a.upload.attachment_id)}s.val(Object.keys(e).length?JSON.stringify({type:"dropzonejs",attachment_ids:e}):"").trigger("change")},this.on("addedfile",function(e){this.element.classList.add("dz-started"),t.dropzonejs_processes++})}},D=t.get_object_meta_value(i,"accept","");""!=D&&(W.acceptedFiles=D);var H=parseInt(t.get_object_meta_value(i,"file_max",0),10);W.maxFiles=o?H>0?H:null:1;var R=parseInt(t.get_object_meta_value(i,"file_max_size",0),10);R>0&&(W.maxFilesize=R);var U=parseInt(t.get_object_meta_value(i,"file_image_max_width",0),10);U>0&&(W.resizeWidth=U);var T=parseInt(t.get_object_meta_value(i,"file_image_max_height",0),10);T>0&&(W.resizeHeight=T);var C="on"==t.get_object_meta_value(i,"file_image_crop","");W.resizeMethod=C?"crop":"contain";var N=parseInt(t.get_object_meta_value(i,"file_image_max_height",100),10);N>0&&(W.resizeQuality=N/100);var P=t.get_object_meta_value(i,"file_image_mime","");""!=P&&(W.resizeMimeType=P);var A=t.get_object_meta_value(i,"file_capture","");""!=A&&(W.capture=A);var J=parseInt(t.get_object_meta_value(i,"file_timeout",""),10);J>0&&(W.timeout=J);var Q=new Dropzone("#"+r+"-dropzonejs",W);e("#"+r+"-dropzonejs").on("click mousedown mouseup mouseover mouseout touchstart touchend touchmove touchcancel",function(t){e("#"+r).trigger(t.type)}),e("#"+r+"-dropzonejs").sortable({items:".wsf-dropzonejs-preview",cursor:"move",tolerance:"pointer",forceHelperSize:!0,cancel:"[data-dz-remove]",start:function(e,a){t.dropzonejs_index_dragged_from=a.helper.index(),a.placeholder.attr("style",h);var i=a.helper.height(),s=a.helper.outerWidth();a.placeholder.css({width:s+"px",height:i+"px"})},stop:function(e,a){var i=t.dropzonejs_index_dragged_from,s=a.item.index();if(s>=Q.files.length)for(var r=s-Q.files.length;1+r--;)Q.files.push(void 0);Q.files.splice(s,0,Q.files.splice(i,1)[0]),Q.input_update()}}),e(this).attr("data-default-value",e(this).val()),t.form_file_dropzonejs_populate(e(this),!1),t.dropzonejs_processes=0,Q.on("sending",function(e,a,i){ws_form_settings.wsf_nonce&&i.append(ws_form_settings.wsf_nonce_field_name,ws_form_settings.wsf_nonce),ws_form_settings.x_wp_nonce&&i.append("_wpnonce",ws_form_settings.x_wp_nonce),i.append("id",t.form_id),i.append("preview",t.form_canvas_obj[0].hasAttribute("data-preview"))}),Q.on("success",function(e,a,i){if(!e.wsf_preload)if(void 0!==a.error&&!1===a.error){if(this.options.success(e),"object"==typeof a.attachment_ids&&a.attachment_ids.length>0){try{var r=JSON.parse(s.val()).attachment_ids}catch(e){r={}}var o=!1;for(var n in a.attachment_ids)if(a.attachment_ids.hasOwnProperty(n)){var l=a.attachment_ids[n];if(-1===Object.values(r).indexOf(l)){o=l;break}}if(!1===o)return;e.upload.attachment_id=o}this.input_update()}else this.options.error(e,a.error_message?a.error_message:t.language("error_file_upload"))}),Q.on("processing",function(){t.form_post_lock("progress",!0,!0)}),Q.on("totaluploadprogress",function(a){n.each(function(){t.form_progress_set_value(e(this),Math.round(a))}),a>99&&e(".wsf-progress",e(this.element)).addClass("wsf-progress-success")}),Q.on("complete",function(){this.ajax_complete()}),Q.on("canceled",function(){this.ajax_complete()}),Q.on("removedfile",function(e){this.input_update(),this.ajax_complete()});var E=s.attr("disabled");E||(E=E||e(this).closest("fieldset").attr("disabled")),E&&Q.disable(),e(this).attr("data-init-file","")})},e.WS_Form.prototype.form_file_dropzonejs_populate=function(t,a){var i=e("+ .dropzone",t)[0].dropzone;if(i.removeAllFiles(!0),t.val(""),!a){var s=t.attr("data-default-value");if(""!=s){try{var r=JSON.parse(s)}catch(e){r=[]}for(var o in r)if(r.hasOwnProperty(o)){var n=r[o];if(void 0!==n.name){var l={processing:!0,accepted:!0,name:n.name,size:n.size,type:n.type,upload:{uuid:n.uuid,attachment_id:n.attachment_id},status:Dropzone.SUCCESS,wsf_preload:!0};i.add_custom_file(l,n.url,{status:"success"})}}i.input_update()}}},e.WS_Form.prototype.form_file_preview=function(t,a,i,s,r){var o=[],n="<div"+(""!=i?' class="'+i+'"':"")+(""!=s?' style="'+s+'"':"")+">";a.html("");for(var l in t)if(t.hasOwnProperty(l)){var d=t[l];switch(d.type){case"image/apng":case"image/bmp":case"image/gif":case"image/jpeg":case"image/png":case"image/svg+xml":case"image/tiff":case"image/webp":case"image/x-icon":o[l]=new FileReader,o[l].wsf_file_index=l,o[l].onload=function(i){var s=this.wsf_file_index,o=i.target.result,l=t[s].name,d=e("<img />");d.attr("src",o),d.attr("alt",l),d.attr("title",l),d.attr("style",r),a.append(n+d[0].outerHTML+"</div>")},o[l].readAsDataURL(d);break;case"video/avi":case"video/mp4":case"video/ogg":case"video/ogm":case"video/ogv":case"video/webm":var p=URL.createObjectURL(d),_=e("<video controls />");_.attr("src",p),_.attr("style",r),_.html(this.language("error_not_supported_video")),a.append(n+_[0].outerHTML+"</div>");break;case"audio/aac":case"audio/aacp":case"audio/flac":case"audio/mp4":case"audio/mpeg":case"audio/ogg":case"audio/wav":case"audio/webm":var c=URL.createObjectURL(d),f=e("<audio controls />");f.attr("src",c),f.attr("style",r+" height: 40px;"),f.html(this.language("error_not_supported_audio")),a.append(n+f[0].outerHTML+"</div>")}}},e.WS_Form.prototype.file_get_count_by_field_id=function(t){var a=e('[name^="'+ws_form_settings.field_prefix+t+'["]',this.form_canvas_obj);if(!a.length)return!1;var i=!1;return a.each(function(){if(e(this).attr("data-file-type")&&"dropzonejs"===e(this).attr("data-file-type")){var t=e(this).closest('[data-type="file"]');if(t){var a=e(".dropzone",t)[0].dropzone;a.files&&(i+=a.files.length)}}else i+=this.files.length}),i}}(jQuery);