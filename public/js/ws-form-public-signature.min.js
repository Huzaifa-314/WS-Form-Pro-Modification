!function(a){"use strict";a.WS_Form.prototype.form_signature=function(){var t=this,e=a('[data-type="signature"]:not([data-init-signature])',this.form_canvas_obj);if(!e.length||"undefined"==typeof SignaturePad)return!1;e.each(function(){a(this).attr("data-init-signature","");var e=a("input",a(this)),i=a("canvas",a(this)),r=i[0],n=e.attr("name"),s=e.attr("data-height");i.attr("style","height: "+s+"; padding: 0; width: 100%;");var o=a(this).attr("data-id"),g=(t.field_data_cache[o],e.attr("data-dot-size")),u=void 0!==e.attr("data-crop"),c=e.attr("data-pen-color"),h=void 0!==e.attr("data-mime")?e.attr("data-mime"):"image/png",m={maxWidth:g,penColor:c},_={signature:!1,canvas:i,canvas_element:r,input:e,name:n,mime:h,config:m,crop:u};if("image/jpeg"==h){var d=void 0!==i.attr("data-background-color")?i.attr("data-background-color"):"#ffffff";m.backgroundColor=d,_.background_color=d}t.signatures.push(_);var v=t.framework.groups.public,f=(v.class_active,v.class_active),l=a(_.canvas_element,t.form_canvas_obj).closest('[id^="'+t.form_id_prefix+'group-"]'),p=l.is(":visible");p||(f?l.addClass(f):l.show());var y=new SignaturePad(_.canvas_element,_.config);_.signature=y,t.signatures_by_name[_.name]=_,_.canvas.parent().find('[data-action="wsf-signature-clear"]').on("click",function(a){a.preventDefault(),_.signature.clear(),_.input.val("").trigger("change")}),_.canvas.on("mousedown touchstart",function(){_.input.val("1").trigger("change")}),a(document).on("keydown",function(a){_.canvas.is(":focus")&&27==a.keyCode&&(_.signature.clear(),_.input.val("").trigger("change"))}),a(window).on("resize",function(){t.signature_redraw(_.signature,_.canvas_element)}),t.signature_redraw(_.signature,_.canvas_element,!0),p||(f?l.removeClass(f):l.hide()),t.form_validate_real_time_process(!1)})},a.WS_Form.prototype.signature_redraw=function(a,t,e){if(void 0===e&&(e=!1),!e&&a.isEmpty()&&(e=!0),!e)var i=a.toDataURL();var r=Math.max(window.devicePixelRatio||1,1);t.width=t.offsetWidth*r,t.height=t.offsetHeight*r,t.getContext("2d").scale(r,r),e?a.clear():a.fromDataURL(i)},a.WS_Form.prototype.signatures_redraw=function(t,e,i){for(var r in void 0===e&&(e=!1),void 0===i&&(i=!1),this.signatures)if(this.signatures.hasOwnProperty(r)){var n=this.signatures[r];if(!1!==n.signature){var s=n.canvas_element,o=this.get_group_index(a(s,this.form_canvas_obj)),g=this.get_section_id(a(s,this.form_canvas_obj)),u=this.get_field_id(a(s,this.form_canvas_obj));(!1!==t&&o==t||!1!==e&&e==g||i==u)&&this.signature_redraw(n.signature,s)}}},a.WS_Form.prototype.signatures_clear=function(){for(var a in this.signatures)if(this.signatures.hasOwnProperty(a)){var t=this.signatures[a];t.signature.clear(),t.input.val("").trigger("change")}},a.WS_Form.prototype.signature_clear_by_name=function(a){var t=void 0!==this.signatures_by_name[a]&&this.signatures_by_name[a];!1!==t&&(t.signature.clear(),t.input.val("").trigger("change"))},a.WS_Form.prototype.signature_get_response_by_name=function(a){var t=void 0!==this.signatures_by_name[a]&&this.signatures_by_name[a];return!1!==t&&""!==t.input.val()},a.WS_Form.prototype.signature_form_post=function(){for(var t in this.signatures)if(this.signatures.hasOwnProperty(t)){var e=this.signatures[t];if(e.signature.isEmpty()||0==e.canvas_element.width||0==e.canvas_element.height)a('[name="'+e.name+'"]',this.form_canvas_obj).val("");else{if(e.crop){if("image/jpeg"==e.mime)var i=this.hex_to_rgb(e.background_color);var r=document.createElement("canvas"),n=r.getContext("2d");r.width=e.canvas_element.width,r.height=e.canvas_element.height,n.drawImage(e.canvas_element,0,0);var s,o,g,u=r.width,c=r.height,h={x:[],y:[]},m=n.getImageData(0,0,r.width,r.height);for(o=0;o<c;o++)for(s=0;s<u;s++)g=4*(o*u+s),"image/jpeg"==e.mime?m.data[g]==i.r&&m.data[g+1]==i.g&&m.data[g+2]==i.b||(h.x.push(s),h.y.push(o)):m.data[g+3]>0&&(h.x.push(s),h.y.push(o));h.x.sort(function(a,t){return a-t}),h.y.sort(function(a,t){return a-t});var _=h.x.length-1;if(u=h.x[_]-h.x[0],c=h.y[_]-h.y[0],u>0&&c>0){var d=n.getImageData(h.x[0],h.y[0],u,c);r.width=u,r.height=c,n.putImageData(d,0,0);var v=r.toDataURL(e.mime)}else v=e.signature.toDataURL(e.mime)}else v=e.signature.toDataURL(e.mime);a('[name="'+e.name+'"]',this.form_canvas_obj).val(v)}}}}(jQuery);